# .github/workflows/ci.yml

name: CI Pipeline - Full Stack Integration Test

on: [push, pull_request]

jobs:
  test_fullstack:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    env:
      # Test database configuration
      DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/test_db?schema=public"
      NODE_ENV: "test"
      PORT: 5175
      VITE_API_TARGET: http://localhost:5175
      JWT_SECRET: "test-jwt-secret-key"
      JWT_REFRESH_SECRET: "test-refresh-secret-key"
      
    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- Backend Setup ---
      - name: ğŸ“¦ Install API Dependencies
        run: |
          cd api
          npm install

      - name: ğŸ—„ï¸ Setup Database Schema
        run: |
          cd api
          npx prisma migrate deploy

      - name: ğŸ”§ Build API (if needed)
        run: |
          cd api
          npm run build

      - name: ğŸŒ± Seed Test Database
        run: |
          cd api
          npx prisma db seed
        env:
          SEED_DISABLE: 0

      - name: ğŸš€ Start API Server
        run: |
          cd api
          echo "Starting API server..."
          npm start > api.log 2>&1 &
          echo "API server process started"
          sleep 5
          echo "API logs after 5 seconds:"
          cat api.log || echo "No log file yet"
        env:
          DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/test_db?schema=public"
          NODE_ENV: "test"
          PORT: 5175


      # --- Frontend Setup ---
      - name: ğŸ“¦ Install Web Dependencies
        run: |
          cd web
          npm install

      - name: ğŸŒ Install Playwright Browsers
        run: |
          cd web
          npx playwright install --with-deps

      # --- Integration Tests ---
      - name: ğŸ§ª Run Full Stack Integration Tests
        run: |
          cd web
          npm run e2e
        env:
          VITE_API_TARGET: http://localhost:5175

      - name: ğŸ“ Upload Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: web/playwright-report/
          retention-days: 7

      # --- Optional: API-only tests ---
      - name: ğŸ” Run API Unit Tests (if available)
        run: |
          cd api
          npm test
        continue-on-error: true  # Don't fail if no tests exist yet

      # --- Debug Information (only runs on failure) ---
      - name: ğŸ› Debug API Server (on failure)
        if: failure()
        run: |
          echo "=== Final API Server Logs ==="
          cat api/api.log || echo "No API log file found"
          echo "=== Final Process List ==="
          ps aux | grep node || echo "No node processes found"
          echo "=== Final Port Usage ==="
          netstat -tlnp | grep 5175 || echo "Port 5175 not in use"